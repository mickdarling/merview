<!-- SPDX-License-Identifier: AGPL-3.0-or-later -->
<!-- Copyright (C) 2025 Mick Darling -->
<!--
    Merview - Mermaid + Markdown Viewer
    Copyright (C) 2025 Mick Darling

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program. If not, see <https://www.gnu.org/licenses/>.

    Source code: https://github.com/mickdarling/merview
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP Note: 'unsafe-inline' is required for script-src and style-src because:
         - CodeMirror dynamically generates inline styles for the editor
         - Mermaid.js generates inline SVG styles for diagrams
         These libraries don't support nonce-based CSP. See SECURITY.md for details. -->
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
                   style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://raw.githubusercontent.com https://gist.githubusercontent.com https://unpkg.com;
                   font-src 'self' data: https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
                   img-src 'self' data: https:;
                   connect-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://raw.githubusercontent.com https://gist.githubusercontent.com https://unpkg.com https://api.github.com;
                   frame-src 'none';
                   object-src 'none';
                   base-uri 'self';">
    <title>Merview - Mermaid + Markdown Viewer</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"
            integrity="sha384-zbcZAIxlvJtNE3Dp5nxLXdXtXyxwOdnILY1TDPVmKFhl4r4nSUG1r8bcFXGVa4Te"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"
            integrity="sha384-+NGfjU8KzpDLXRHduEqW+ZiJr2rIg+cidUVk7B51R5xK7cHwMKQfrdFwGdrq1Bcz"
            crossorigin="anonymous"></script>
    <!-- Syntax highlighting - using full bundle with all languages -->
    <!-- Theme loaded dynamically by JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"
            integrity="sha384-F/bZzf7p3Joyp5psL90p/p89AZJsndkSoGwRpXcZhleCWhd8SnRuoYo4d0yirjJp"
            crossorigin="anonymous"></script>

    <!-- CodeMirror 5 for editor syntax highlighting (reliable script-tag loading) -->
    <!-- Theme CSS loaded dynamically from styles/editor/*.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css"
          integrity="sha384-zaeBlB/vwYsDRSlFajnDd7OydJ0cWk+c2OWybl3eSUf6hW2EbhlCsQPqKr3gkznT"
          crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"
            integrity="sha384-BEgQlz0fN4eG0n4jipmUe+nOg65hPY7L0E/lPVRaOPdzAfLPGEbXnpAodHtSnlwM"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/markdown/markdown.min.js"
            integrity="sha384-nPWqI+4+e+SwcpI6LVYBpaQd+zIZIQgC6lN7Gep8MJQr5DdmMGtWV8qJQgcyODcF"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/gfm/gfm.min.js"
            integrity="sha384-owcyd1tfdpiSNWJdvXDH+GRNcgrtWravOMajtO0Gejjw8s+TUJA0I8obL3l3kYbu"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/javascript/javascript.min.js"
            integrity="sha384-g0o+WW9mdIxA7LaaCKTkRm0M5TVT+Bb4s9eocxPsI2G0Xm0POG9iD6G6qP1IIsfS"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/xml/xml.min.js"
            integrity="sha384-xPpkMo5nDgD98fIcuRVYhxkZV6/9Y4L8s3p0J5c4MxgJkyKJ8BJr+xfRkq7kn6Tw"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/css/css.min.js"
            integrity="sha384-fpeIC2FZuPmw7mIsTvgB5BNc8QVxQC/nWg2W+CgPYOAiBiYVuHe2E8HiTWHBMIJQ"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/yaml/yaml.min.js"
            integrity="sha384-9q49Jm3hZMwxEMLImsxPxLiaptHpFz1PVa26Dg6SVIO+rj5kx0cgOM2+4ikKJFH9"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/python/python.min.js"
            integrity="sha384-Xy+2exU6lBoT4OpUOtnQb+cUpn+nlJQEHvRobWVtwz6wIsw4oNoO7xyd/l8rYgMy"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/edit/continuelist.min.js"
            integrity="sha384-ew54Ry5+wy74QeO2dHPrrhU+KDKvd1D6yOI2/K31tuA7IuzhvUpPqDNbqSR1UEWM"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/mode/overlay.min.js"
            integrity="sha384-g9ZAntHz8wq4eO03zXothSSZmCViVkPXhen5AaLIH4KaZVkjce0ME/TXTpRgsyDh"
            crossorigin="anonymous"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .toolbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            height: 28px;
            width: auto;
        }

        .toolbar h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .brand-tagline {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            padding-left: 12px;
        }

        .github-link {
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .github-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        .github-label {
            font-size: 12px;
        }

        .toolbar-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .style-selector {
            background: #34495e;
            color: white;
            border: 1px solid #4a6278;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            outline: none;
        }

        .style-selector:hover {
            background: #415b76;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .container {
            display: flex;
            flex: 1;
            min-height: 0; /* Required for flex children to scroll properly in Firefox/Safari */
        }

        .site-footer {
            background: #1a252f;
            color: rgba(255, 255, 255, 0.5);
            padding: 6px 20px;
            font-size: 11px;
            text-align: center;
            flex-shrink: 0;
            user-select: none;
        }

        .site-footer a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
        }

        .site-footer a:hover {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: underline;
        }

        .editor-panel, .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .resize-handle {
            width: 8px;
            background: #34495e;
            cursor: col-resize;
            position: relative;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .resize-handle:hover {
            background: #3498db;
        }

        .resize-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 40px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .panel-header {
            background: #34495e;
            color: white;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-selectors {
            display: flex;
            gap: 8px;
        }

        .panel-selector {
            background: #2c3e50;
            color: white;
            border: 1px solid #4a6278;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            outline: none;
        }

        .panel-selector:hover {
            background: #415b76;
        }

        #editor-container {
            flex: 1;
            overflow: hidden;
            /* Background controlled by editor theme CSS */
        }

        /* CodeMirror 5 styling - structure only, colors from theme */
        #editor-container .CodeMirror {
            height: 100%;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            /* Background controlled by editor theme CSS */
        }

        /* Gutters styling controlled by editor theme CSS */

        #editor-container.drag-over {
            outline: 2px dashed #3498db;
            outline-offset: -2px;
        }

        /* Editor theme loaded dynamically from styles/editor/*.css */

        .preview-panel {
            background: white;
            border-left: 1px solid #ddd;
            position: relative;
        }

        /*
         * Preview container - maintain layout, prevent style leaking.
         * IMPORTANT PATTERN: Most properties use !important to override loaded styles and
         * prevent layout/style leakage. However, 'background' deliberately does NOT use
         * !important to allow JavaScript (applyPreviewBackground) to apply dark theme
         * backgrounds dynamically when dark mode CSS is loaded.
         */
        #preview {
            flex: 1 !important;
            overflow-y: auto !important;
            background: white; /* No !important - see comment above */
            display: block !important;
            position: relative !important;
            /* Prevent styles from affecting the container */
            width: auto !important;
            max-width: none !important;
            margin: 0 !important;
            font-family: initial !important;
            font-size: initial !important;
            line-height: initial !important;
            color: initial !important;
        }

        /* Wrapper for Marked2 styles - base structure only */
        /* Note: Background/color come from loaded styles */
        /* Layout constraints (max-width, margin) controlled via JS based on toggle */
        #wrapper {
            display: block;
            padding: 20px;
        }

        /* Mermaid diagram styling */
        .mermaid-container {
            position: relative;
            margin: 20px 0;
        }

        .mermaid {
            text-align: center;
        }

        .mermaid-expand-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(52, 73, 94, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .mermaid-container:hover .mermaid-expand-btn {
            opacity: 1;
        }

        .mermaid-expand-btn:hover {
            background: rgba(52, 152, 219, 0.9);
        }

        /* Fullscreen overlay for mermaid diagrams */
        .mermaid-fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .mermaid-fullscreen-overlay .mermaid-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .mermaid-fullscreen-overlay .mermaid-close-btn:hover {
            background: #c0392b;
        }

        .mermaid-fullscreen-overlay .mermaid-fullscreen-content {
            width: 95vw;
            height: 85vh;
            overflow: hidden;
            cursor: grab;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mermaid-fullscreen-overlay .mermaid-fullscreen-content:active {
            cursor: grabbing;
        }

        .mermaid-fullscreen-overlay .mermaid-fullscreen-content svg {
            transform-origin: center center;
            transition: none;
            max-width: 100%;
            max-height: 100%;
        }

        /* Double-click hint cursor on mermaid diagrams */
        .mermaid-container .mermaid {
            cursor: zoom-in;
        }

        .mermaid-fullscreen-overlay .mermaid-zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(52, 73, 94, 0.9);
            padding: 8px 16px;
            border-radius: 8px;
            z-index: 10;
        }

        .mermaid-fullscreen-overlay .mermaid-zoom-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .mermaid-fullscreen-overlay .mermaid-zoom-btn:hover {
            background: #2980b9;
        }

        .mermaid-fullscreen-overlay .mermaid-zoom-level {
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            min-width: 50px;
            justify-content: center;
        }

        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .status.show {
            opacity: 1;
        }

        .lint-panel {
            position: fixed;
            bottom: -300px;
            left: 0;
            right: 0;
            height: 300px;
            background: #2c3e50;
            border-top: 2px solid #3498db;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            transition: bottom 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .lint-panel.show {
            bottom: 0;
        }

        .lint-header {
            background: #34495e;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 14px;
        }

        .lint-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
        }

        .lint-close:hover {
            color: #e74c3c;
        }

        .lint-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
            color: #ecf0f1;
        }

        .lint-empty {
            color: #95a5a6;
            font-style: italic;
        }

        .lint-issue {
            background: #34495e;
            border-left: 4px solid #e74c3c;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .lint-issue.warning {
            border-left-color: #f39c12;
        }

        .lint-issue-header {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lint-issue-type {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #e74c3c;
            color: white;
        }

        .lint-issue.warning .lint-issue-type {
            background: #f39c12;
        }

        .lint-issue-message {
            font-size: 13px;
            line-height: 1.4;
        }

        .lint-issue-location {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 5px;
        }

        #lintToggle.active {
            background: #3498db;
            color: white;
        }

        @media print {
            /* Force color printing FIRST - preserve ALL colors and backgrounds */
            *, *::before, *::after {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            /* Hide editor and toolbar - show only preview */
            .toolbar, .editor-panel, .panel-header, .resize-handle, .status, .lint-panel, .site-footer {
                display: none !important;
            }

            .container {
                display: block !important;
                height: auto !important;
            }

            .preview-panel {
                border: none !important;
                width: 100% !important;
            }

            #preview {
                overflow: visible !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                /* Remove all the constraints */
                max-width: none !important;
                font-family: inherit !important;
                font-size: inherit !important;
                line-height: inherit !important;
                color: inherit !important;
            }

            /* Ensure wrapper displays and maintains all styling */
            #wrapper {
                display: block !important;
                padding: 20px !important;
            }

            /* Force syntax highlighting colors to print */
            #wrapper pre,
            #wrapper code,
            #wrapper pre code,
            #wrapper .hljs,
            #wrapper .hljs * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            /* Preserve code block structure in print */
            #wrapper pre code.hljs {
                display: block !important;
                padding: 1em !important;
            }

            /* Ensure diagrams and images print well */
            .mermaid, img, svg, table, blockquote, pre {
                page-break-inside: avoid;
            }

            img, svg {
                max-width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <header class="toolbar-brand" aria-label="Merview application branding">
            <img src="images/logo.png" alt="Merview - Mermaid diagram and Markdown editor" class="brand-logo">
            <h1>Merview</h1>
            <span class="brand-tagline">Mermaid + Markdown Editor</span>
            <a href="https://github.com/mickdarling/merview" target="_blank" rel="noopener noreferrer" class="github-link" title="View source on GitHub (AGPL-3.0)" aria-label="View Merview source code on GitHub (AGPL-3.0 license)">
                <span class="github-label">Source</span>
                <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
            </a>
        </header>
        <div class="toolbar-buttons">
            <button class="btn" onclick="openFile()">üìÇ Open</button>
            <button class="btn btn-success" onclick="saveFile()">üíæ Save</button>
            <button class="btn btn-success" onclick="saveFileAs()">üì• Save As</button>
            <button class="btn" id="lintToggle" onclick="toggleLintPanel()">üîç Code Validation</button>
            <button class="btn btn-success" onclick="exportToPDF()">üñ®Ô∏è Print/PDF</button>
            <button class="btn btn-success" onclick="exportToPDFDirect()">üìÑ Print (New Tab)</button>
            <button class="btn" onclick="loadSample()">üìã Load Sample</button>
            <button class="btn btn-danger" onclick="clearEditor()">üóëÔ∏è Clear</button>
        </div>
    </div>

    <div class="lint-panel" id="lintPanel">
        <div class="lint-header">
            <span>Code Validation Issues</span>
            <button class="lint-close" onclick="toggleLintPanel()">‚úï</button>
        </div>
        <div class="lint-content" id="lintContent">
            <p class="lint-empty">No issues found or validation disabled.</p>
        </div>
    </div>

    <div class="container">
        <div class="editor-panel">
            <div class="panel-header">
                <span>Editor</span>
                <select class="panel-selector" id="editorThemeSelector" onchange="changeEditorTheme(this.value)" title="Editor syntax highlighting">
                    <option value="">Theme...</option>
                </select>
            </div>
            <div id="editor-container">
                <textarea id="editor"></textarea>
            </div>
        </div>

        <div class="resize-handle" id="resizeHandle"></div>

        <div class="preview-panel">
            <div class="panel-header">
                <span>Preview</span>
                <div class="panel-selectors">
                    <select class="panel-selector" id="styleSelector" onchange="changeStyle(this.value)" title="Document style">
                        <option value="">Style...</option>
                    </select>
                    <select class="panel-selector" id="syntaxThemeSelector" onchange="changeSyntaxTheme(this.value)" title="Code block theme">
                        <option value="">Code...</option>
                    </select>
                </div>
            </div>
            <div id="preview">
                <div id="wrapper"></div>
            </div>
        </div>
    </div>

    <footer class="site-footer" role="contentinfo" aria-label="Site footer with copyright and license information">
        <span>&copy; <span id="copyright-year">2025</span> <a href="https://github.com/mickdarling" target="_blank" rel="noopener noreferrer">Mick Darling</a>. Open source under <a href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank" rel="noopener noreferrer">AGPL-3.0</a>.</span>
    </footer>

    <div class="status" id="status"></div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'strict',  // Security: Prevents XSS attacks through malicious diagrams
        });

        const editorTextarea = document.getElementById('editor');
        const editorContainer = document.getElementById('editor-container');
        const preview = document.getElementById('preview');
        const wrapper = document.getElementById('wrapper');
        const statusDiv = document.getElementById('status');
        const styleSelector = document.getElementById('styleSelector');
        const resizeHandle = document.getElementById('resizeHandle');
        const container = document.querySelector('.container');
        const editorPanel = document.querySelector('.editor-panel');
        const previewPanel = document.querySelector('.preview-panel');
        const lintPanel = document.getElementById('lintPanel');
        const lintContent = document.getElementById('lintContent');
        const lintToggle = document.getElementById('lintToggle');
        const syntaxThemeSelector = document.getElementById('syntaxThemeSelector');
        const editorThemeSelector = document.getElementById('editorThemeSelector');

        let renderTimeout;
        let respectStyleLayout = localStorage.getItem('respect-style-layout') === 'true';
        let layoutToggleOption = null; // Cached reference for performance
        let mermaidCounter = 0;
        let currentStyleLink = null;
        let currentSyntaxThemeLink = null;
        let lintEnabled = false;
        let codeIssues = [];
        let cmEditor = null; // CodeMirror instance
        let currentEditorThemeLink = null; // Editor theme CSS link

        // Initialize CodeMirror 5
        function initCodeMirror() {
            cmEditor = CodeMirror.fromTextArea(editorTextarea, {
                mode: 'gfm', // GitHub Flavored Markdown
                theme: 'custom', // Our custom theme loaded from styles/editor/
                lineNumbers: true,
                lineWrapping: true,
                autofocus: true,
                dragDrop: false, // Disable drag and drop of selections
                extraKeys: {
                    'Enter': 'newlineAndIndentContinueMarkdownList',
                    'Ctrl-S': function(cm) { saveFile(); return false; },
                    'Cmd-S': function(cm) { saveFile(); return false; }
                }
            });

            // Listen for changes
            cmEditor.on('change', function() {
                scheduleRender();
            });

            // Expose global helper functions
            globalThis.getEditorContent = function() {
                return cmEditor.getValue();
            };

            globalThis.setEditorContent = function(content) {
                cmEditor.setValue(content);
            };

            // Handle drag and drop on the CodeMirror wrapper
            const cmWrapper = cmEditor.getWrapperElement();

            cmWrapper.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                editorContainer.classList.add('drag-over');
            });

            cmWrapper.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                editorContainer.classList.remove('drag-over');
            });

            cmWrapper.addEventListener('drop', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                editorContainer.classList.remove('drag-over');
                handleFileDrop(e);
            });

            return cmEditor;
        }

        // Available syntax highlighting themes for PREVIEW code blocks (highlight.js)
        // SRI hashes for CDN security - only themes that exist on cdnjs are included
        const syntaxThemeSRI = {
            "github-dark": "sha384-wH75j6z1lH97ZOpMOInqhgKzFkAInZPPSPlZpYKYTOqsaizPvhQZmAtLcPKXpLyH",
            "github": "sha384-eFTL69TLRZTkNfYZOLM+G04821K1qZao/4QLJbet1pP4tcF+fdXq/9CdqAbWRl/L",
            "vs2015": "sha384-BE+nmfgoK1j3fBxbLI64Jzf52Mx/QAyw+4O7GyPYevJnAyrljCoRtQkYNfCfuWPF",
            "monokai": "sha384-88Jvj9Q2LiBDwL7w3yciRTcH5q2zzvMFYIm4xX9/evqxJsxA33Xk9XYKcvUlPITo",
            "atom-one-dark": "sha384-oaMLBGEzBOJx3UHwac0cVndtX5fxGQIfnAeFZ35RTgqPcYlbprH9o9PUV/F8Le07",
            "atom-one-light": "sha384-w6Ujm1VWa9HYFqGc89oAPn/DWDi2gUamjNrq9DRvEYm2X3ClItg9Y9xs1ViVo5b5",
            "nord": "sha384-O/y538KpolLjYHZH8xqC17hcGWgjOw79vqDDhXNIT6Q7q3O5KVr29xbsaq9k6fSL",
            "tokyo-night-dark": "sha384-6PRNB60loRkq5oYgj0ETV33K0YsTUlab8qtfTGXhRgW5Nz1IpzS2zwj6UmlJEnyV",
            "tokyo-night-light": "sha384-lz4BwxazQPl/J1rzkk6RsFZF7C3C9nqhym6EpONldqrEQ42XNaYx9Saeo6wpqiy2",
            "night-owl": "sha384-xMH/akAd4WIJSWGsUlveLGugns8GuYeJglqHRpASAW0sSbPNVM+BIa4Xa/50+uaJ",
            "obsidian": "sha384-8YFghPfkz+a3Ed4rE78f/ccgF16mVMS3jvYmTGEFK06nkeIXmcgZsDWgefgDzWlI",
            "agate": "sha384-Yno0F1TwvVYWd95R9B4ViD8Z/XeywVsysQN8gRKbgRFu/jzdbWtrXEVNuBuUWR5I"
        };

        const syntaxThemes = [
            { name: 'GitHub Dark', file: 'github-dark', default: true },
            { name: 'GitHub Light', file: 'github' },
            { name: 'VS Code Dark+', file: 'vs2015' },
            { name: 'Monokai', file: 'monokai' },
            { name: 'Atom One Dark', file: 'atom-one-dark' },
            { name: 'Atom One Light', file: 'atom-one-light' },
            { name: 'Nord', file: 'nord' },
            { name: 'Tokyo Night Dark', file: 'tokyo-night-dark' },
            { name: 'Tokyo Night Light', file: 'tokyo-night-light' },
            { name: 'Night Owl', file: 'night-owl' },
            { name: 'Obsidian', file: 'obsidian' },
            { name: 'Agate', file: 'agate' }
        ];

        // Available EDITOR themes (CodeMirror - local CSS files you can customize)
        const editorThemes = [
            { name: 'Material Darker', file: 'material-darker', default: true },
            { name: 'GitHub Dark', file: 'github-dark' },
            { name: 'Monokai', file: 'monokai' },
            { name: 'Dracula', file: 'dracula' },
            { name: 'Solarized Dark', file: 'solarized-dark' },
            { name: 'Solarized Light', file: 'solarized-light' }
        ];

        // Resize handle functionality
        let isResizing = false;

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const containerRect = container.getBoundingClientRect();
            const newLeftWidth = e.clientX - containerRect.left;
            const containerWidth = containerRect.width;
            const handleWidth = 8;

            // Calculate percentage, ensuring minimum widths
            const minWidth = 200;
            const maxLeftWidth = containerWidth - minWidth - handleWidth;

            if (newLeftWidth >= minWidth && newLeftWidth <= maxLeftWidth) {
                const leftPercent = (newLeftWidth / containerWidth) * 100;
                const rightPercent = 100 - leftPercent - (handleWidth / containerWidth * 100);

                editorPanel.style.flex = `0 0 ${leftPercent}%`;
                previewPanel.style.flex = `0 0 ${rightPercent}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        // Built-in custom styles (MIT licensed - created by us)
        const availableStyles = [
            { name: 'None (No CSS)', file: '', source: 'none' },
            { name: '---', file: '', source: 'separator' }, // Separator
            { name: 'Clean', file: 'styles/clean.css', source: 'local', default: true },
            { name: 'Academic', file: 'styles/academic.css', source: 'local' },
            { name: 'GitHub', file: 'styles/github.css', source: 'local' },
            { name: 'Dark Mode', file: 'styles/dark.css', source: 'local' },
            { name: 'Monospace', file: 'styles/monospace.css', source: 'local' },
            { name: 'Newspaper', file: 'styles/newspaper.css', source: 'local' },
            { name: '---', file: '', source: 'separator' }, // Separator
            { name: 'Respect Style Layout', file: '', source: 'toggle' },
            { name: '---', file: '', source: 'separator' }, // Separator
            { name: 'Load from file...', file: '', source: 'file' },
            { name: 'Load from URL...', file: '', source: 'url' },
            { name: '---', file: '', source: 'separator' }, // Separator
            { name: 'MarkedCustomStyles (external)', file: '', source: 'repository',
              url: 'https://cdn.jsdelivr.net/gh/ttscoff/MarkedCustomStyles@master/',
              note: 'Third-party styles (license unclear)' }
        ];

        // Hidden file input for loading CSS files
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.css';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);

        // Load style from various sources
        // Handle special style source types (none, file, url, repository)
        async function handleSpecialStyleSource(style) {
            if (style.source === 'none') {
                // Remove all custom styles
                if (currentStyleLink) {
                    currentStyleLink.remove();
                    currentStyleLink = null;
                }
                showStatus('CSS removed');
                await renderMarkdown();
                return true;
            }
            if (style.source === 'file') {
                fileInput.click();
                return true;
            }
            if (style.source === 'url') {
                promptForURL();
                return true;
            }
            if (style.source === 'repository') {
                promptForRepositoryStyle(style);
                return true;
            }
            return false;
        }

        /**
         * Validate that a CSS value is a safe background color.
         * Prevents potentially malicious values like javascript: URLs.
         * @param {string} value - The CSS background value to validate
         * @returns {boolean} True if the value is a safe color format
         */
        function isValidBackgroundColor(value) {
            const trimmed = value.trim().toLowerCase();
            // Block dangerous patterns first
            if (trimmed.includes('javascript:') || trimmed.includes('url(')) {
                return false;
            }
            // Allow safe color formats:
            // - Hex: #fff, #ffffff, #ffffffff (with alpha)
            // - RGB/RGBA: rgb(0,0,0), rgba(0,0,0,0.5)
            // - HSL/HSLA: hsl(0,0%,0%), hsla(0,0%,0%,0.5)
            // - Named colors: white, black, transparent, etc.
            const safePatterns = [
                /^#[0-9a-f]{3,8}$/,                    // hex colors
                /^rgba?\s*\([^)]+\)$/,                 // rgb/rgba
                /^hsla?\s*\([^)]+\)$/,                 // hsl/hsla
                /^[a-z]+$/                             // named colors (no special chars)
            ];
            return safePatterns.some(pattern => pattern.test(trimmed));
        }

        /**
         * Extract background color from loaded CSS and apply to preview container.
         * Parses the #wrapper rule to find background or background-color values.
         *
         * SUPPORTED background types:
         * - Hex colors: #1e1e1e, #fff, #ffffff
         * - Named colors: white, black, darkgray, transparent
         * - RGB/RGBA values: rgb(30, 30, 30), rgba(0, 0, 0, 0.9)
         * - HSL/HSLA values: hsl(0, 0%, 12%), hsla(0, 0%, 12%, 0.95)
         *
         * NOT SUPPORTED (will fall back to white):
         * - CSS variables: var(--bg-color), var(--theme-background)
         * - Gradients: linear-gradient(...), radial-gradient(...)
         * - Complex multi-value backgrounds: url(...) #fff, image-set(...)
         *
         * This limitation is due to regex-based CSS parsing. For dark themes,
         * always use simple color values on #wrapper background property.
         *
         * @param {string} cssText - The loaded CSS text to parse
         */
        function applyPreviewBackground(cssText) {
            if (!preview) return; // Guard against missing element

            // Look for #wrapper background in the CSS
            // Match patterns like: #wrapper { ... background: #1e1e1e; ... }
            // or: #wrapper { ... background-color: #1e1e1e; ... }
            const wrapperMatch = cssText.match(/#wrapper\s*\{[^}]*\}/);
            if (wrapperMatch) {
                const wrapperRule = wrapperMatch[0];
                // Extract background or background-color value
                const bgMatch = wrapperRule.match(/background(?:-color)?\s*:\s*([^;}\s]+(?:\s+[^;}\s]+)*)/);
                if (bgMatch) {
                    const bgValue = bgMatch[1].trim();
                    // Validate the color value for security before applying
                    if (isValidBackgroundColor(bgValue)) {
                        preview.style.background = bgValue;
                        return;
                    }
                }
            }
            // Default to white if no valid background found
            preview.style.background = 'white';
        }

        /**
         * Apply or remove layout constraint overrides based on the "Respect Style Layout" toggle.
         * When OFF (default): Forces full-width layout, user controls width via drag handle.
         * When ON: Allows loaded styles to apply their own max-width, margins, and gutters.
         */
        function applyLayoutConstraints() {
            if (!wrapper) return; // Guard against missing element

            if (respectStyleLayout) {
                // Remove overrides - let loaded style control layout
                wrapper.style.maxWidth = '';
                wrapper.style.margin = '';
                wrapper.style.width = '';
            } else {
                // Apply overrides - user controls width via drag handle
                wrapper.style.maxWidth = 'none';
                wrapper.style.margin = '0';
                wrapper.style.width = 'auto';
            }
        }

        // Apply loaded CSS to the page
        async function applyStyleToPage(cssText, styleName, style) {
            // Remove @media print blocks that might override colors for printing
            cssText = stripPrintMediaQueries(cssText);

            // Scope the CSS to only affect #wrapper (the content area)
            if (style.source !== 'local' && !cssText.includes('#wrapper')) {
                cssText = scopeCSSToPreview(cssText);
            }

            // Remove previous style if exists
            if (currentStyleLink) {
                currentStyleLink.remove();
            }

            // Create style element with scoped CSS
            const styleElement = document.createElement('style');
            styleElement.id = 'marked-custom-style';
            styleElement.textContent = cssText;
            document.head.appendChild(styleElement);

            currentStyleLink = styleElement;

            // Extract and apply background color from style to preview container
            applyPreviewBackground(cssText);

            // Apply layout constraints based on toggle setting
            applyLayoutConstraints();

            // Apply minimal structure override (no color changes)
            applySyntaxOverride();

            // Save preference
            localStorage.setItem('markdown-style', styleName);

            // Re-render markdown to update Mermaid diagrams with new CSS
            await renderMarkdown();
        }

        async function loadStyle(styleName) {
            const style = availableStyles.find(s => s.name === styleName);
            if (!style || style.source === 'separator') return;

            // Handle special actions (file picker, URL prompt, etc.)
            if (await handleSpecialStyleSource(style)) return;

            showStatus(`Loading style: ${style.name}...`);

            try {
                // Load from local styles/ directory or external URL
                const response = await fetch(style.file);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const cssText = await response.text();

                await applyStyleToPage(cssText, styleName, style);
                showStatus(`Style loaded: ${style.name}`);
            } catch (error) {
                showStatus(`Error loading style: ${style.name}`);
                console.error(`Failed to load style:`, error);
            }
        }

        // Helper: Check if current position starts a print media query
        function isPrintMediaStart(css, i) {
            const startsWithPrint = css.substring(i, i + 12) === '@media print';
            const startsWithScreen = css.substring(i, i + 13) === '@media screen';
            // Handle indexOf returning -1 (not found) by treating as "no print before brace"
            const printIndex = css.indexOf('print', i);
            const braceIndex = css.indexOf('{', i);
            const hasPrintBeforeBrace = printIndex !== -1 && braceIndex !== -1 && printIndex < braceIndex;
            return startsWithPrint || (startsWithScreen && hasPrintBeforeBrace);
        }

        // Helper: Skip to the opening brace of a media query
        function skipToOpeningBrace(css, startIndex) {
            let i = startIndex;
            while (i < css.length && css[i] !== '{') {
                i++;
            }
            return i;
        }

        // Helper: Process a character when inside a print media block
        function processInsidePrintMedia(css, i, depth) {
            if (css[i] === '{') {
                return { newDepth: depth + 1, stillInPrintMedia: true };
            }
            if (css[i] === '}') {
                const newDepth = depth - 1;
                return { newDepth, stillInPrintMedia: newDepth > 0 };
            }
            return { newDepth: depth, stillInPrintMedia: true };
        }

        // Strip @media print blocks from CSS to preserve screen colors in PDF
        function stripPrintMediaQueries(css) {
            let depth = 0;
            let inPrintMedia = false;
            let result = '';
            let i = 0;

            while (i < css.length) {
                if (!inPrintMedia && isPrintMediaStart(css, i)) {
                    const restOfLine = css.substring(i, css.indexOf('{', i) + 1);
                    if (restOfLine.includes('print')) {
                        inPrintMedia = true;
                        depth = 0;
                        i = skipToOpeningBrace(css, i);
                        continue;
                    }
                }

                if (inPrintMedia) {
                    const { newDepth, stillInPrintMedia } = processInsidePrintMedia(css, i, depth);
                    depth = newDepth;
                    inPrintMedia = stillInPrintMedia;
                    i++;
                } else {
                    result += css[i];
                    i++;
                }
            }

            return result;
        }

        // Scope CSS to only affect #wrapper using a more robust approach
        function scopeCSSToPreview(css) {
            // Much simpler approach: just scope every selector we find
            // Use regex to find all CSS rules and scope their selectors

            // First, replace body/html with #wrapper at the start of selectors
            // Note: replaceAll() with regex requires the global (g) flag
            css = css.replaceAll(/(^|[,\s])(body|html)(\s*[,{:])/gm, '$1#wrapper$3');

            // Then scope all other selectors by adding #wrapper prefix
            // This regex finds selectors (text before {) and prefixes them
            css = css.replaceAll(/([^\r\n,{}]+)(,(?=[^}]*{)|\s*{)/g, function(match, selector, separator) {
                selector = selector.trim();

                // Skip if it's a comment, @-rule, or already scoped
                if (selector.startsWith('/*') ||
                    selector.startsWith('@') ||
                    selector.includes('#wrapper') ||
                    selector.includes('#preview')) {
                    return match;
                }

                // Handle multiple selectors separated by commas
                const selectors = selector.split(',').map(s => {
                    s = s.trim();
                    if (!s || s.startsWith('@')) return s;

                    // If it doesn't start with #wrapper, add it
                    if (!s.startsWith('#wrapper')) {
                        return '#wrapper ' + s;
                    }
                    return s;
                }).join(', ');

                return selectors + separator;
            });

            return css;
        }

        // Simple override: just set structure, let .hljs handle colors naturally
        function applySyntaxOverride() {
            let syntaxOverride = document.getElementById('syntax-override');
            if (!syntaxOverride) {
                syntaxOverride = document.createElement('style');
                syntaxOverride.id = 'syntax-override';
                document.head.appendChild(syntaxOverride);
            }

            // Minimal override - just structure, NO color overrides
            syntaxOverride.textContent = `
                /* Let syntax theme .hljs rule handle ALL colors naturally */
                #wrapper pre {
                    padding: 0;
                    margin: 1em 0;
                }

                #wrapper pre code.hljs {
                    display: block;
                    padding: 1em;
                    overflow-x: auto;
                    border-radius: 4px;
                }
            `;
        }

        // Update just the checkbox state for the layout toggle option (uses cached reference)
        function updateLayoutToggleCheckbox() {
            if (layoutToggleOption) {
                layoutToggleOption.textContent = (respectStyleLayout ? '‚úì ' : '‚òê ') + 'Respect Style Layout';
            }
        }

        // Change style
        async function changeStyle(styleName) {
            if (!styleName) return;

            // Handle toggle option
            if (styleName === 'Respect Style Layout') {
                respectStyleLayout = !respectStyleLayout;
                localStorage.setItem('respect-style-layout', respectStyleLayout);
                applyLayoutConstraints();
                // Update just the checkbox without rebuilding the entire dropdown
                updateLayoutToggleCheckbox();
                // Restore previous selection
                const currentStyle = localStorage.getItem('markdown-style') || 'Clean';
                styleSelector.value = currentStyle;
                showStatus(respectStyleLayout ? 'Style layout respected' : 'Style layout overridden');
                return;
            }

            await loadStyle(styleName);
        }

        // Load CSS from uploaded file
        async function loadCSSFromFile(file) {
            if (!file || !file.name.endsWith('.css')) {
                showStatus('Please select a valid CSS file');
                return;
            }

            try {
                showStatus(`Loading: ${file.name}...`);
                const cssText = await file.text();
                await applyCSSDirectly(cssText, file.name);
                showStatus(`Loaded: ${file.name}`);
            } catch (error) {
                showStatus(`Error loading file: ${error.message}`);
                console.error('File load error:', error);
            }
        }

        // Prompt user for URL
        function promptForURL() {
            const url = prompt('Enter CSS file URL:\n\n' +
                'Allowed domains (for security):\n' +
                '‚Ä¢ raw.githubusercontent.com\n' +
                '‚Ä¢ cdn.jsdelivr.net\n' +
                '‚Ä¢ cdnjs.cloudflare.com\n' +
                '‚Ä¢ gist.githubusercontent.com\n' +
                '‚Ä¢ unpkg.com\n\n' +
                'Example:\nhttps://raw.githubusercontent.com/user/repo/main/style.css');

            if (url) {
                loadCSSFromURL(url);
            }
        }

        // Allowed domains for loading external CSS (security allowlist)
        const ALLOWED_CSS_DOMAINS = [
            'cdn.jsdelivr.net',
            'cdnjs.cloudflare.com',
            'raw.githubusercontent.com',
            'gist.githubusercontent.com',
            'unpkg.com'
        ];

        // Allowed domains for loading remote markdown (security allowlist)
        const ALLOWED_MARKDOWN_DOMAINS = [
            'raw.githubusercontent.com',
            'gist.githubusercontent.com'
        ];

        // Validate URL against allowlist (HTTPS only, case-insensitive)
        function isAllowedCSSURL(url) {
            try {
                const parsed = new URL(url);
                if (parsed.protocol !== 'https:') {
                    console.warn('CSS URL blocked: HTTPS required, got', parsed.protocol);
                    return false;
                }
                const isAllowed = ALLOWED_CSS_DOMAINS.includes(parsed.hostname.toLowerCase());
                if (isAllowed) {
                    return true;
                }
                console.warn('CSS URL blocked: domain not in allowlist:', parsed.hostname);
                return false;
            } catch (error) {
                console.warn('CSS URL blocked: invalid URL format:', url, error.message);
                return false;
            }
        }

        // Validate markdown URL against allowlist (HTTPS only, case-insensitive)
        function isAllowedMarkdownURL(url) {
            try {
                const parsed = new URL(url);
                if (parsed.protocol !== 'https:') {
                    console.warn('Markdown URL blocked: HTTPS required, got', parsed.protocol);
                    return false;
                }
                const isAllowed = ALLOWED_MARKDOWN_DOMAINS.includes(parsed.hostname.toLowerCase());
                if (!isAllowed) {
                    console.warn('Markdown URL blocked: domain not in allowlist:', parsed.hostname);
                }
                return isAllowed;
            } catch (error) {
                console.warn('Markdown URL blocked: invalid URL format:', url, error.message);
                return false;
            }
        }
        // Expose for testing
        globalThis.isAllowedMarkdownURL = isAllowedMarkdownURL;

        // Load markdown from URL (with domain validation)
        async function loadMarkdownFromURL(url) {
            if (!isAllowedMarkdownURL(url)) {
                showStatus(`URL not allowed. Trusted: ${ALLOWED_MARKDOWN_DOMAINS.join(', ')}`);
                return false;
            }

            try {
                showStatus('Loading from URL...');
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const markdown = await response.text();

                if (cmEditor) {
                    cmEditor.setValue(markdown);
                }

                // Extract filename from URL for display
                const urlPath = new URL(url).pathname;
                currentFilename = urlPath.split('/').pop() || 'remote.md';

                await renderMarkdown();
                showStatus(`Loaded: ${currentFilename}`);
                return true;
            } catch (error) {
                console.error('Error loading URL:', error);
                showStatus(`Error loading URL: ${error.message}`);
                return false;
            }
        }

        // Load CSS from URL (with domain validation)
        async function loadCSSFromURL(url) {
            // Validate URL against allowlist
            if (!isAllowedCSSURL(url)) {
                showStatus(`URL not allowed. Trusted: ${ALLOWED_CSS_DOMAINS.join(', ')}`);
                return;
            }

            try {
                showStatus(`Loading from URL...`);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const cssText = await response.text();
                await applyCSSDirectly(cssText, url);
                showStatus(`Loaded from URL`);
            } catch (error) {
                showStatus(`Error loading URL: ${error.message}`);
                console.error('URL load error:', error);
            }
        }

        // Prompt for repository-based style (like MarkedCustomStyles)
        async function promptForRepositoryStyle(repoConfig) {
            const fileName = prompt(`Enter CSS filename from ${repoConfig.name}:\n\n` +
                `Repository: ${repoConfig.url}\n\n` +
                `${repoConfig.note || ''}\n\n` +
                `Example: Academia.css`);

            if (fileName) {
                const fullURL = repoConfig.url + encodeURIComponent(fileName);
                await loadCSSFromURL(fullURL);
            }
        }

        // Apply CSS directly without scope processing (for already-scoped files)
        async function applyCSSDirectly(cssText, sourceName) {
            // Strip print media queries
            cssText = stripPrintMediaQueries(cssText);

            // Only scope if it doesn't appear to be pre-scoped
            if (!cssText.includes('#wrapper')) {
                cssText = scopeCSSToPreview(cssText);
            }

            // Remove previous style
            if (currentStyleLink) {
                currentStyleLink.remove();
            }

            // Create style element
            const styleElement = document.createElement('style');
            styleElement.id = 'marked-custom-style';
            styleElement.textContent = cssText;
            document.head.appendChild(styleElement);

            currentStyleLink = styleElement;

            // Apply minimal structure override
            applySyntaxOverride();

            // Save preference (if it's a named style)
            if (sourceName && !sourceName.startsWith('http')) {
                localStorage.setItem('markdown-style', sourceName);
            }

            // Re-render to apply styles
            await renderMarkdown();
        }

        // File input handler
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await loadCSSFromFile(file);
            }
            // Reset input so same file can be loaded again
            fileInput.value = '';
        });

        // Drag and drop CSS files onto preview
        preview.addEventListener('dragover', (e) => {
            const items = e.dataTransfer.items;
            for (let item of items) {
                if (item.type === 'text/css' || item.kind === 'file') {
                    e.preventDefault();
                    e.stopPropagation();
                    preview.style.outline = '3px dashed #3498db';
                    return;
                }
            }
        });

        preview.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            preview.style.outline = '';
        });

        preview.addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            preview.style.outline = '';

            const files = e.dataTransfer.files;
            if (files.length === 0) return;

            const file = files[0];

            // Check if it's a CSS file
            if (file.name.endsWith('.css') || file.type === 'text/css') {
                await loadCSSFromFile(file);
            } else {
                showStatus('Please drop a CSS file to change styles');
            }
        });

        // Load syntax highlighting theme
        async function loadSyntaxTheme(themeName) {
            const theme = syntaxThemes.find(t => t.name === themeName);
            if (!theme) return;

            // Verify theme has SRI hash for security
            const sriHash = syntaxThemeSRI[theme.file];
            if (!sriHash) {
                console.error(`No SRI hash for theme: ${theme.file}`);
                return;
            }

            try {
                // Remove previous theme
                if (currentSyntaxThemeLink) {
                    currentSyntaxThemeLink.remove();
                }

                // Load new theme with SRI verification
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/${theme.file}.min.css`;
                link.integrity = sriHash;
                link.crossOrigin = 'anonymous';
                link.id = 'syntax-theme';

                // Wait for CSS to load before continuing
                await new Promise((resolve, reject) => {
                    link.onload = resolve;
                    link.onerror = reject;
                    document.head.appendChild(link);
                });

                currentSyntaxThemeLink = link;

                // CRITICAL: Wait a bit for browser to parse the stylesheet
                // The onload event fires when downloaded, but CSSOM might not be ready
                await new Promise(resolve => setTimeout(resolve, 100));

                // Save preference
                localStorage.setItem('syntax-theme', themeName);

                showStatus(`Syntax theme: ${theme.name}`);
            } catch (error) {
                console.error('Failed to load syntax theme:', error);
                showStatus(`Error loading syntax theme: ${theme.name}`);
            }
        }

        // Change syntax theme
        async function changeSyntaxTheme(themeName) {
            if (!themeName) return;
            await loadSyntaxTheme(themeName);
            // Re-render to apply new syntax theme
            await renderMarkdown();
        }

        // Initialize syntax theme selector (for preview code blocks)
        async function initSyntaxThemeSelector() {
            syntaxThemeSelector.innerHTML = '';

            syntaxThemes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.name;
                option.textContent = theme.name;
                syntaxThemeSelector.appendChild(option);
            });

            // Load saved theme or default
            const savedTheme = localStorage.getItem('syntax-theme');
            const defaultTheme = syntaxThemes.find(t => t.default)?.name || 'GitHub Dark';
            const themeToLoad = savedTheme || defaultTheme;

            syntaxThemeSelector.value = themeToLoad;
            await loadSyntaxTheme(themeToLoad);
        }

        // Load editor theme (CodeMirror) from local CSS files
        async function loadEditorTheme(themeName) {
            const theme = editorThemes.find(t => t.name === themeName);
            if (!theme) return;

            try {
                // Remove previous editor theme
                if (currentEditorThemeLink) {
                    currentEditorThemeLink.remove();
                }

                // Load new theme from local styles/editor/ directory
                const response = await fetch(`styles/editor/${theme.file}.css`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const cssText = await response.text();

                // Create style element
                const styleElement = document.createElement('style');
                styleElement.id = 'editor-theme';
                styleElement.textContent = cssText;
                document.head.appendChild(styleElement);

                currentEditorThemeLink = styleElement;

                // Save preference
                localStorage.setItem('editor-theme', themeName);

                showStatus(`Editor theme: ${theme.name}`);
            } catch (error) {
                console.error('Failed to load editor theme:', error);
                showStatus(`Error loading editor theme: ${theme.name}`);
            }
        }

        // Change editor theme
        async function changeEditorTheme(themeName) {
            if (!themeName) return;
            await loadEditorTheme(themeName);
        }

        // Initialize editor theme selector
        async function initEditorThemeSelector() {
            editorThemeSelector.innerHTML = '';

            editorThemes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.name;
                option.textContent = theme.name;
                editorThemeSelector.appendChild(option);
            });

            // Load saved theme or default
            const savedTheme = localStorage.getItem('editor-theme');
            const defaultTheme = editorThemes.find(t => t.default)?.name || 'Material Darker';
            const themeToLoad = savedTheme || defaultTheme;

            editorThemeSelector.value = themeToLoad;
            await loadEditorTheme(themeToLoad);
        }

        // Initialize style selector
        async function initStyleSelector() {
            styleSelector.innerHTML = '';

            availableStyles.forEach(style => {
                const option = document.createElement('option');
                option.value = style.name;
                option.textContent = style.name;

                // Handle separators
                if (style.source === 'separator') {
                    option.disabled = true;
                    option.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                }

                // Handle toggle with checkmark and cache reference for performance
                if (style.source === 'toggle') {
                    option.textContent = (respectStyleLayout ? '‚úì ' : '‚òê ') + style.name;
                    layoutToggleOption = option;
                }

                styleSelector.appendChild(option);
            });

            // Load saved style or default
            const savedStyle = localStorage.getItem('markdown-style');
            const defaultStyle = availableStyles.find(s => s.default)?.name || 'Clean';
            const styleToLoad = savedStyle || defaultStyle;

            styleSelector.value = styleToLoad;
            await loadStyle(styleToLoad);
        }

        // Check if highlight.js loaded successfully
        console.log('highlight.js available:', typeof hljs !== 'undefined');
        if (typeof hljs !== 'undefined') {
            console.log('highlight.js version:', hljs.versionString || 'unknown');
            console.log('Loaded languages:', hljs.listLanguages ? hljs.listLanguages().length : 'N/A');
        }

        // Initialize on page load
        initStyleSelector();
        initSyntaxThemeSelector();
        initEditorThemeSelector();

        // Configure marked to handle mermaid code blocks
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        /**
         * Generate a URL-friendly slug from heading text.
         * Converts to lowercase, replaces spaces with hyphens, removes special chars.
         * @param {string} text - The heading text to slugify
         * @returns {string} URL-friendly slug
         */
        function slugify(text) {
            return text
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '')   // Remove special chars (keeps letters, numbers, underscore, hyphen, space)
                .replace(/[\s_]+/g, '-')    // Replace spaces and underscores with hyphens
                .replace(/-+/g, '-')        // Collapse multiple hyphens
                .replace(/^-|-$/g, '');     // Trim leading/trailing hyphens
        }

        // Custom renderer to handle mermaid blocks, syntax highlighting, and heading IDs
        const renderer = new marked.Renderer();
        const originalCodeRenderer = renderer.code;

        // Add heading renderer to generate IDs for anchor links
        renderer.heading = function(text, level) {
            const slug = slugify(text);
            return `<h${level} id="${slug}">${text}</h${level}>\n`;
        };

        renderer.code = function(code, language) {
            if (language === 'mermaid') {
                const id = `mermaid-${mermaidCounter++}`;
                return `<div class="mermaid-container">
                    <button class="mermaid-expand-btn" onclick="expandMermaid('${id}')" title="Expand diagram">‚õ∂</button>
                    <div class="mermaid" id="${id}" ondblclick="expandMermaid('${id}')">${code}</div>
                </div>`;
            }

            // Check if highlight.js is available
            if (typeof hljs === 'undefined') {
                console.error('highlight.js (hljs) is not loaded!');
                const escaped = code.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
                return `<pre><code data-language="${language || 'text'}">${escaped}</code></pre>`;
            }

            // Apply syntax highlighting for other code blocks
            try {
                if (language) {
                    // Normalize language names (yaml/yml are the same)
                    const normalizedLang = language.toLowerCase();
                    const langMap = {
                        'yml': 'yaml'
                    };
                    const mappedLang = langMap[normalizedLang] || normalizedLang;

                    if (hljs.getLanguage(mappedLang)) {
                        const highlighted = hljs.highlight(code, { language: mappedLang, ignoreIllegals: true });
                        const html = `<pre><code class="hljs language-${mappedLang}" data-language="${mappedLang}">${highlighted.value}</code></pre>`;
                        console.log('‚úì Highlighted', mappedLang, 'code block');
                        console.log('  Generated HTML preview:', html.substring(0, 200));
                        return html;
                    } else {
                        console.warn('Language not supported by highlight.js:', language);
                    }
                }
            } catch (err) {
                console.error('Highlight error for language', language, ':', err);
                // Fall through to auto-detection on error
            }

            // Fallback to auto-detection or plain rendering
            try {
                const highlighted = hljs.highlightAuto(code);
                console.log('Auto-detected language:', highlighted.language || 'none');
                return `<pre><code class="hljs" data-language="${highlighted.language || language || 'text'}">${highlighted.value}</code></pre>`;
            } catch (err) {
                console.error('Auto-highlight error:', err);
                // Final fallback to plain code block
                const escaped = code.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
                return `<pre><code data-language="${language || 'text'}">${escaped}</code></pre>`;
            }
        };

        marked.setOptions({ renderer });

        // Render markdown with mermaid
        async function renderMarkdown() {
            try {
                console.log('Starting renderMarkdown...');
                const markdown = cmEditor ? cmEditor.getValue() : '';

                // Reset mermaid counter
                mermaidCounter = 0;

                // Convert markdown to HTML
                const html = marked.parse(markdown);
                wrapper.innerHTML = html;
                console.log('HTML rendered, mermaid elements:', wrapper.querySelectorAll('.mermaid').length);

                // Render mermaid diagrams
                const mermaidElements = wrapper.querySelectorAll('.mermaid');

                for (const element of mermaidElements) {
                    try {
                        const { svg } = await mermaid.render(element.id + '-svg', element.textContent);
                        element.innerHTML = svg;
                    } catch (error) {
                        console.error('Mermaid render error:', error);
                        element.innerHTML = `<div style="color: red; padding: 10px; border: 1px solid red; border-radius: 4px;">
                            <strong>Mermaid Error:</strong><br>${error.message}
                        </div>`;
                    }
                }

                // Save to localStorage
                localStorage.setItem('markdown-content', markdown);

                // Debug: Check what code blocks are in the DOM
                const codeBlocks = wrapper.querySelectorAll('pre code');
                console.log('=== DOM Inspection ===');
                console.log('Total code blocks in DOM:', codeBlocks.length);
                codeBlocks.forEach((block, i) => {
                    const classList = Array.from(block.classList).join(', ');
                    const lang = block.dataset.language;
                    const hasHljsClass = block.classList.contains('hljs');
                    console.log(`  Block ${i + 1}: classes=[${classList}] lang=${lang} hasHljs=${hasHljsClass}`);
                });

                // Run validation if enabled
                if (lintEnabled) {
                    validateCode();
                }

                console.log('renderMarkdown completed successfully');
            } catch (error) {
                console.error('Critical error in renderMarkdown:', error);
                showStatus('Error rendering: ' + error.message);
            }
        }

        // Debounced render function
        function scheduleRender() {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(renderMarkdown, 300);
        }

        // Expose renderMarkdown globally
        globalThis.renderMarkdown = renderMarkdown;

        // Sync highlighting removed
        function initSync() {
            // Placeholder - sync removed
        }

        // Export to PDF using browser's print dialog
        function exportToPDF() {
            // Validate content exists
            if (!wrapper.innerHTML || wrapper.innerHTML.trim() === '') {
                showStatus('Error: No content to export');
                return;
            }

            // Use the browser's native print dialog
            // This will use our @media print CSS rules
            showStatus('Opening print dialog...');

            // Small delay to allow status message to show
            setTimeout(() => {
                globalThis.print();
            }, 100);
        }

        // Alternative: Save as PDF programmatically (for browsers that support it)
        async function exportToPDFDirect() {
            // Validate content exists
            if (!wrapper.innerHTML || wrapper.innerHTML.trim() === '') {
                showStatus('Error: No content to export');
                return;
            }

            console.log('Starting PDF export...');
            showStatus('Generating PDF...');

            try {
                // Get the current custom style CSS if available
                let customStyleCSS = currentStyleLink ? currentStyleLink.textContent : '';

                // The CSS is already processed (print media queries stripped, scoped)
                // Just need to remove #wrapper scoping for the print window
                // since the entire document IS the wrapper content
                if (customStyleCSS) {
                    customStyleCSS = customStyleCSS.replaceAll(/#wrapper\s+/g, '');
                    customStyleCSS = customStyleCSS.replaceAll(/#preview\s+/g, '');
                }

                // Create a printable version
                const printWindow = window.open('', '_blank');

                printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="${currentSyntaxThemeLink ? currentSyntaxThemeLink.href : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css'}">
    <style>
        /* Force color printing FIRST - preserve ALL colors and backgrounds */
        *, *::before, *::after {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        /* Specifically force syntax highlighting colors */
        pre, code, pre code, .hljs, .hljs * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        /* Custom Marked2 Style */
        ${customStyleCSS}

        /* Minimal fallback styles if no custom style loaded */
        ${customStyleCSS ? '' : `
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            font-size: 11pt;
            line-height: 1.6;
            color: #000;
        }
        h1 { font-size: 24pt; margin-top: 16px; margin-bottom: 12px; page-break-after: avoid; }
        h2 { font-size: 18pt; margin-top: 14px; margin-bottom: 10px; page-break-after: avoid; }
        h3 { font-size: 14pt; margin-top: 12px; margin-bottom: 8px; page-break-after: avoid; }
        pre { background: #f5f5f5; padding: 12px; page-break-inside: avoid; }
        code { background: #f5f5f5; padding: 2px 4px; }
        `}

        /* Ensure print compatibility */
        .mermaid {
            margin: 16px 0;
            text-align: center;
            page-break-inside: avoid;
        }
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
        img, svg {
            max-width: 100%;
            height: auto;
            page-break-inside: avoid;
        }

        @media print {
            *, *::before, *::after {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
${wrapper.innerHTML}
</body>
</html>
                `);

                printWindow.document.close();

                // Wait for content and styles to fully load then trigger print
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        showStatus('Print dialog opened');
                    }, 500);
                };
            } catch (error) {
                console.error('PDF generation error:', error);
                showStatus('Error: ' + error.message);
            }
        }

        // Load sample content
        function loadSample() {
            const sample = `# Comprehensive Markdown + Mermaid Feature Demo

Welcome to the **Merview** demonstration document! This file showcases all the features including syntax highlighting, Mermaid diagrams, tables, and various formatting options.

## Table of Contents

1. [Text Formatting](#text-formatting)
2. [Lists](#lists)
3. [Code Blocks](#code-blocks)
4. [Tables](#tables)
5. [Mermaid Diagrams](#mermaid-diagrams)
6. [Blockquotes](#blockquotes)

---

## Text Formatting

You can use **bold text**, *italic text*, ***bold and italic***, ~~strikethrough~~, and \`inline code\`.

Here's a paragraph with some [links to external resources](https://github.com). Links are automatically styled according to your selected theme.

### Subheadings Work Too

And they render beautifully with the custom styles applied!

---

## Lists

### Unordered Lists

- First item
- Second item
  - Nested item 1
  - Nested item 2
- Third item
- Fourth item with **bold** and *italic*

### Ordered Lists

1. Step one: Install the renderer
2. Step two: Open the HTML file
3. Step three: Start writing Markdown
   1. Sub-step A
   2. Sub-step B
4. Step four: Export to PDF

### Task Lists

- [x] Completed task
- [x] Another completed task
- [ ] Pending task
- [ ] Another pending task

---

## Code Blocks

### JavaScript (labeled)

\`\`\`javascript
function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

// Calculate the 10th Fibonacci number
const result = fibonacci(10);
console.log(\`Fibonacci(10) = \${result}\`);

// Arrow function example
const greet = (name) => \`Hello, \${name}!\`;
\`\`\`

### Python (labeled)

\`\`\`python
def quick_sort(arr):
    """Quick sort algorithm implementation"""
    if len(arr) <= 1:
        return arr

    pivot = arr[len(arr) // 2]
    left = [x for x in arr if x < pivot]
    middle = [x for x in arr if x == pivot]
    right = [x for x in arr if x > pivot]

    return quick_sort(left) + middle + quick_sort(right)

# Example usage
numbers = [3, 6, 8, 10, 1, 2, 1]
sorted_numbers = quick_sort(numbers)
print(f"Sorted: {sorted_numbers}")
\`\`\`

### YAML Configuration (labeled)

\`\`\`yaml
# Application Configuration
application:
  name: "Markdown Renderer"
  version: "1.0.0"
  author:
    name: "Development Team"
    email: "team@example.com"

server:
  host: "localhost"
  port: 8080
  ssl:
    enabled: true
    certificate: "/path/to/cert.pem"

features:
  - syntax-highlighting
  - mermaid-diagrams
  - pdf-export
  - custom-themes

themes:
  default: "Academia"
  available:
    - name: "GitHub"
      type: "technical"
    - name: "Torpedo"
      type: "creative"
\`\`\`

### JSON Data (labeled)

\`\`\`json
{
  "project": {
    "name": "Merview",
    "version": "1.0.0",
    "description": "A beautiful Markdown renderer with Mermaid support",
    "features": [
      "Real-time rendering",
      "Syntax highlighting",
      "37 professional themes",
      "PDF export"
    ],
    "config": {
      "autoSave": true,
      "theme": "Academia",
      "lintEnabled": false
    },
    "stats": {
      "lines": 1247,
      "size": "45KB",
      "lastModified": "2025-01-21T11:55:00Z"
    }
  }
}
\`\`\`

### Code Without Language Label (unlabeled)

\`\`\`
This is a code block without a language label.
It will use auto-detection or render as plain text.

function example() {
    return "No syntax highlighting specified";
}

The renderer will still format it nicely!
\`\`\`

---

## Tables

### Basic Table

| Feature | Status | Priority |
|---------|--------|----------|
| Markdown Rendering | ‚úÖ Complete | High |
| Mermaid Diagrams | ‚úÖ Complete | High |
| Syntax Highlighting | ‚úÖ Complete | High |
| PDF Export | ‚úÖ Complete | Medium |
| Code Validation | ‚úÖ Complete | Low |

### Complex Table with Formatting

| Language | Extension | Highlighting | Validation | Notes |
|----------|-----------|--------------|------------|-------|
| **JavaScript** | \`.js\` | ‚úÖ Yes | ‚úÖ Syntax Check | Most popular |
| **Python** | \`.py\` | ‚úÖ Yes | ‚ùå No | Coming soon |
| **YAML** | \`.yaml\`, \`.yml\` | ‚úÖ Yes | ‚ùå No | Config files |
| **JSON** | \`.json\` | ‚úÖ Yes | ‚úÖ Parse Check | Data format |

---

## Mermaid Diagrams

### Flowchart

\`\`\`mermaid
graph TD
    A[Start Application] --> B{User Action?}
    B -->|Load File| C[Parse Markdown]
    B -->|Type Text| D[Real-time Render]
    B -->|Export PDF| E[Generate PDF]
    C --> F[Apply Syntax Highlighting]
    D --> F
    F --> G[Render Mermaid]
    G --> H[Apply Custom Style]
    H --> I[Display Preview]
    E --> J[Open Print Dialog]
    J --> K[Save PDF]
    K --> L[End]
    I --> B
\`\`\`

### Sequence Diagram

\`\`\`mermaid
sequenceDiagram
    participant User
    participant Editor
    participant Renderer
    participant Mermaid
    participant Preview

    User->>Editor: Type Markdown
    Editor->>Renderer: Request Render
    Renderer->>Renderer: Parse Markdown
    Renderer->>Mermaid: Render Diagrams
    Mermaid-->>Renderer: SVG Output
    Renderer->>Preview: Update HTML
    Preview-->>User: Display Result

    User->>Editor: Drop File
    Editor->>Renderer: Load Content
    Renderer->>Preview: Render Complete
    Preview-->>User: Show Document
\`\`\`

### Class Diagram

\`\`\`mermaid
classDiagram
    class MarkdownRenderer {
        +String content
        +Style currentStyle
        +Boolean lintEnabled
        +render()
        +loadStyle(name)
        +exportPDF()
    }

    class CodeHighlighter {
        +highlight(code, language)
        +autoDetect(code)
        +getLanguage(name)
    }

    class MermaidEngine {
        +render(element, content)
        +initialize(config)
    }

    class StyleManager {
        +loadFromGitHub(url)
        +scopeCSS(css)
        +stripPrintMedia(css)
    }

    MarkdownRenderer --> CodeHighlighter
    MarkdownRenderer --> MermaidEngine
    MarkdownRenderer --> StyleManager
\`\`\`

---

## Blockquotes

> **Note:** This is a blockquote. It's perfect for highlighting important information or quotes.

> You can have multiple paragraphs in a blockquote.
>
> Like this one! The styling is applied based on your selected theme.

---

## Tips for Using This Renderer

1. **Choose Your Style**: Select from 37 professional themes in the dropdown
2. **Real-time Preview**: The preview updates as you type
3. **Drag & Drop**: Drop any \`.md\` file to load it instantly
4. **Resize Panels**: Drag the handle between editor and preview to adjust sizes
5. **Export Options**:
   - Use **Print/PDF** for in-place printing
   - Use **Print (New Tab)** to open in a new window first
6. **Code Validation**: Toggle the validation panel to check your code blocks

---

**Happy documenting!** üìù`;

            if (cmEditor) {
                cmEditor.setValue(sample);
            }
            renderMarkdown();
        }

        // Expose loadSample globally
        globalThis.loadSample = loadSample;

        // Track current filename for "Save" functionality
        let currentFilename = null;

        // Hidden file input for Open File button (markdown files)
        const mdFileInput = document.createElement('input');
        mdFileInput.type = 'file';
        mdFileInput.accept = '.md,.markdown,.txt,.text';
        mdFileInput.style.display = 'none';
        document.body.appendChild(mdFileInput);

        // Shared file loading logic (used by both file picker and drag-and-drop)
        async function loadMarkdownFile(file) {
            try {
                const content = await file.text();
                if (cmEditor) {
                    cmEditor.setValue(content);
                }
                currentFilename = file.name;
                await renderMarkdown();
                showStatus(`Loaded: ${file.name}`);
                return true;
            } catch (error) {
                console.error('Error loading file:', error);
                showStatus(`Error loading file: ${error.message}`);
                return false;
            }
        }

        // Validate file type (text or markdown)
        // Security: Only accept specific MIME types or valid markdown extensions
        // Empty MIME type requires valid extension (some browsers don't set MIME for .md files)
        function isValidMarkdownFile(file) {
            const validMimeTypes = ['text/plain', 'text/markdown', 'text/x-markdown'];
            const validExtensions = /\.(md|markdown|txt|text)$/i;

            // If MIME type is set and valid, accept
            if (file.type && validMimeTypes.includes(file.type)) {
                return true;
            }
            // If MIME type is empty or not in whitelist, require valid extension
            return validExtensions.test(file.name);
        }
        // Expose for testing
        globalThis.isValidMarkdownFile = isValidMarkdownFile;

        // Open file using native file picker
        function openFile() {
            mdFileInput.click();
        }

        // Handle file selection from file picker
        mdFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Defensive validation (browser's accept attribute can be bypassed)
            if (!isValidMarkdownFile(file)) {
                showStatus('Please select a text or markdown file');
                mdFileInput.value = '';
                return;
            }

            await loadMarkdownFile(file);

            // Reset input so the same file can be selected again
            mdFileInput.value = '';
        });

        // Save file (uses current filename or prompts for one)
        function saveFile() {
            if (currentFilename) {
                downloadFile(currentFilename);
            } else {
                saveFileAs();
            }
        }

        // Save As - always prompts for filename
        function saveFileAs() {
            const defaultName = currentFilename || 'document.md';
            const filename = prompt('Save as:', defaultName);

            if (filename) {
                // Ensure .md extension
                const finalName = filename.endsWith('.md') ? filename : filename + '.md';
                currentFilename = finalName;
                downloadFile(finalName);
            }
        }

        // Expose saveFile globally for CodeMirror Ctrl+S binding
        globalThis.saveFile = saveFile;

        // Download the markdown content as a file
        function downloadFile(filename) {
            const content = cmEditor ? cmEditor.getValue() : '';
            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            showStatus(`Saved: ${filename}`);
        }

        // Clear editor
        function clearEditor() {
            if (confirm('Are you sure you want to clear the editor?')) {
                if (cmEditor) {
                    cmEditor.setValue('');
                }
                currentFilename = null;
                renderMarkdown();
            }
        }

        // Show status message
        function showStatus(message) {
            statusDiv.textContent = message;
            statusDiv.classList.add('show');
            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 3000);
        }

        // Toggle lint panel
        function toggleLintPanel() {
            lintEnabled = !lintEnabled;
            lintPanel.classList.toggle('show');
            lintToggle.classList.toggle('active');

            if (lintEnabled) {
                validateCode();
            }
        }

        // Validate code blocks
        function validateCode() {
            codeIssues = [];
            const codeBlocks = wrapper.querySelectorAll('pre code[data-language]');

            codeBlocks.forEach((block, index) => {
                const language = block.dataset.language;
                const code = block.textContent;

                // Validate based on language
                switch (language) {
                    case 'json':
                        validateJSON(code, index);
                        break;
                    case 'javascript':
                    case 'js':
                        validateJavaScript(code, index);
                        break;
                    case 'html':
                        validateHTML(code, index);
                        break;
                    case 'css':
                        validateCSS(code, index);
                        break;
                }
            });

            updateLintPanel();
        }

        // JSON validation
        function validateJSON(code, blockIndex) {
            try {
                JSON.parse(code);
            } catch (error) {
                codeIssues.push({
                    type: 'error',
                    language: 'JSON',
                    block: blockIndex + 1,
                    message: error.message
                });
            }
        }

        // Basic JavaScript validation
        // NOTE: JavaScript validation has been removed for security reasons.
        // Using Function constructor to validate JS code can execute arbitrary code.
        // For proper JS validation, use a dedicated linting tool like ESLint.
        function validateJavaScript(code, blockIndex) {
            // Disabled for security - would require a proper parser library
            // to validate without executing code
            return;
        }

        // Basic HTML validation
        function validateHTML(code, blockIndex) {
            // Check for common issues
            const issues = [];

            // Unclosed tags
            const openTags = code.match(/<(\w+)[^>]*>/g) || [];
            const closeTags = code.match(/<\/(\w+)>/g) || [];

            if (openTags.length !== closeTags.length) {
                issues.push('Possible unclosed HTML tags');
            }

            // Missing DOCTYPE in full HTML documents
            if (code.includes('<html') && !code.includes('<!DOCTYPE')) {
                issues.push('Missing DOCTYPE declaration');
            }

            issues.forEach(issue => {
                codeIssues.push({
                    type: 'warning',
                    language: 'HTML',
                    block: blockIndex + 1,
                    message: issue
                });
            });
        }

        // Basic CSS validation
        function validateCSS(code, blockIndex) {
            // Check for common issues
            const braceOpen = (code.match(/{/g) || []).length;
            const braceClose = (code.match(/}/g) || []).length;

            if (braceOpen !== braceClose) {
                codeIssues.push({
                    type: 'error',
                    language: 'CSS',
                    block: blockIndex + 1,
                    message: 'Mismatched braces'
                });
            }
        }

        // Update lint panel with issues
        function updateLintPanel() {
            if (codeIssues.length === 0) {
                lintContent.innerHTML = '<p class="lint-empty">‚úÖ No issues found in code blocks!</p>';
                return;
            }

            let html = '';
            codeIssues.forEach(issue => {
                html += `
                    <div class="lint-issue ${issue.type}">
                        <div class="lint-issue-header">
                            <span class="lint-issue-type">${issue.type.toUpperCase()}</span>
                            <span>${issue.language} - Block #${issue.block}</span>
                        </div>
                        <div class="lint-issue-message">${issue.message}</div>
                    </div>
                `;
            });

            lintContent.innerHTML = html;
        }

        // Mermaid fullscreen functionality with zoom/pan
        let mermaidZoom = { scale: 1, panX: 0, panY: 0, isPanning: false, startX: 0, startY: 0 };

        function expandMermaid(mermaidId) {
            const mermaidElement = document.getElementById(mermaidId);
            if (!mermaidElement) return;

            // Reset zoom state
            mermaidZoom = { scale: 1, panX: 0, panY: 0, isPanning: false, startX: 0, startY: 0 };

            // Clone the SVG content
            const svgContent = mermaidElement.innerHTML;

            // Create fullscreen overlay
            const overlay = document.createElement('div');
            overlay.className = 'mermaid-fullscreen-overlay';
            overlay.id = 'mermaid-fullscreen-overlay';
            overlay.innerHTML = `
                <button class="mermaid-close-btn" onclick="closeMermaidFullscreen()">‚úï Close</button>
                <div class="mermaid-fullscreen-content" id="mermaid-pan-area">${svgContent}</div>
                <div class="mermaid-zoom-controls">
                    <button class="mermaid-zoom-btn" onclick="mermaidZoomIn()">+</button>
                    <span class="mermaid-zoom-level" id="mermaid-zoom-level">100%</span>
                    <button class="mermaid-zoom-btn" onclick="mermaidZoomOut()">‚àí</button>
                    <button class="mermaid-zoom-btn" onclick="mermaidZoomReset()">Reset</button>
                </div>
            `;

            document.body.appendChild(overlay);

            // Set up pan area
            const panArea = document.getElementById('mermaid-pan-area');
            const svg = panArea.querySelector('svg');

            if (svg) {
                // Make SVG fill the container initially
                svg.style.width = '100%';
                svg.style.height = '100%';
                updateMermaidTransform();
            }

            // Mouse wheel zoom
            panArea.addEventListener('wheel', handleMermaidWheel, { passive: false });

            // Pan with mouse drag
            panArea.addEventListener('mousedown', handleMermaidPanStart);
            document.addEventListener('mousemove', handleMermaidPanMove);
            document.addEventListener('mouseup', handleMermaidPanEnd);

            // Close on Escape key
            document.addEventListener('keydown', handleMermaidEscape);
        }

        function updateMermaidTransform() {
            const panArea = document.getElementById('mermaid-pan-area');
            if (!panArea) return;
            const svg = panArea.querySelector('svg');
            if (!svg) return;

            svg.style.transform = `translate(${mermaidZoom.panX}px, ${mermaidZoom.panY}px) scale(${mermaidZoom.scale})`;

            const zoomLevel = document.getElementById('mermaid-zoom-level');
            if (zoomLevel) {
                zoomLevel.textContent = Math.round(mermaidZoom.scale * 100) + '%';
            }
        }

        function mermaidZoomIn() {
            mermaidZoom.scale = Math.min(mermaidZoom.scale * 1.25, 10);
            updateMermaidTransform();
        }

        function mermaidZoomOut() {
            mermaidZoom.scale = Math.max(mermaidZoom.scale / 1.25, 0.1);
            updateMermaidTransform();
        }

        function mermaidZoomReset() {
            mermaidZoom.scale = 1;
            mermaidZoom.panX = 0;
            mermaidZoom.panY = 0;
            updateMermaidTransform();
        }

        function handleMermaidWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            mermaidZoom.scale = Math.min(Math.max(mermaidZoom.scale * delta, 0.1), 10);
            updateMermaidTransform();
        }

        function handleMermaidPanStart(e) {
            if (e.target.closest('.mermaid-zoom-controls')) return;
            mermaidZoom.isPanning = true;
            mermaidZoom.startX = e.clientX - mermaidZoom.panX;
            mermaidZoom.startY = e.clientY - mermaidZoom.panY;
        }

        function handleMermaidPanMove(e) {
            if (!mermaidZoom.isPanning) return;
            mermaidZoom.panX = e.clientX - mermaidZoom.startX;
            mermaidZoom.panY = e.clientY - mermaidZoom.startY;
            updateMermaidTransform();
        }

        function handleMermaidPanEnd() {
            mermaidZoom.isPanning = false;
        }

        function closeMermaidFullscreen() {
            const overlay = document.getElementById('mermaid-fullscreen-overlay');
            if (overlay) {
                overlay.remove();
            }
            document.removeEventListener('keydown', handleMermaidEscape);
            document.removeEventListener('mousemove', handleMermaidPanMove);
            document.removeEventListener('mouseup', handleMermaidPanEnd);
        }

        function handleMermaidEscape(e) {
            if (e.key === 'Escape') {
                closeMermaidFullscreen();
            }
        }

        // Note: Content loading on startup is handled by the CodeMirror module
        // which reads from localStorage and calls renderMarkdown/loadSample

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S to save file
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }

            // Ctrl/Cmd + P to print/export PDF
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                exportToPDF();
            }

            // Ctrl/Cmd + Shift + P to print in new tab
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'P') {
                e.preventDefault();
                exportToPDFDirect();
            }
        });

        // Centralized file drop handler
        async function handleFileDrop(e) {
            const files = e.dataTransfer.files;

            if (files.length === 0) {
                showStatus('No file dropped');
                return;
            }

            const file = files[0];

            // Validate file type
            if (!isValidMarkdownFile(file)) {
                showStatus('Please drop a text or markdown file');
                return;
            }

            await loadMarkdownFile(file);
        }

        // Initialize the application
        globalThis.addEventListener('DOMContentLoaded', function() {
            // Set dynamic copyright year
            document.getElementById('copyright-year').textContent = new Date().getFullYear();

            // Initialize CodeMirror
            initCodeMirror();

            // Initialize editor <-> preview sync highlighting
            initSync();

            // Check for URL parameter to load remote markdown
            const urlParams = new URLSearchParams(globalThis.location.search);
            const remoteURL = urlParams.get('url');

            if (remoteURL) {
                // Load from URL parameter
                // URL is kept in browser bar so users can share/bookmark the link
                loadMarkdownFromURL(remoteURL);
            } else {
                // Load saved content or sample
                const saved = localStorage.getItem('markdown-content');
                if (saved) {
                    cmEditor.setValue(saved);
                    renderMarkdown();
                } else {
                    loadSample();
                }
            }
        });
    </script>
</body>
</html>
